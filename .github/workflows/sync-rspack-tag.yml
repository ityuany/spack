name: Sync Rspack Tag
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Rspack tag to sync (e.g., v1.4.0)'
        required: true
        type: string

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Clone rspack repository
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "ðŸ”„ Cloning rspack repository..."
          
          # å…‹éš†rspackä»“åº“
          git clone https://github.com/web-infra-dev/rspack.git rspack-source
          cd rspack-source
          
          echo "ðŸ“‹ Available tags:"
          git tag | grep -E "^v[0-9]" | tail -10
          
          # æ£€æŸ¥tagæ˜¯å¦å­˜åœ¨
          if ! git rev-parse --verify "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "âŒ Tag $TAG not found in rspack repository"
            echo "Available tags:"
            git tag | grep -E "^v[0-9]" | tail -20
            exit 1
          fi
          
          # åˆ‡æ¢åˆ°æŒ‡å®štag
          echo "ðŸ”„ Checking out tag $TAG..."
          git checkout "$TAG"
          
          echo "âœ… Successfully cloned rspack at tag $TAG"
      
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          path: target-repo
      
      - name: Create sync branch from target repo
        run: |
          TAG="${{ github.event.inputs.tag }}"
          SYNC_BRANCH="sync-rspack-$TAG-$(date +%Y%m%d-%H%M%S)"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV
          
          cd target-repo
          
          # åŸºäºŽmainåˆ†æ”¯åˆ›å»ºåŒæ­¥åˆ†æ”¯ï¼ˆä¿æŒgitåŽ†å²è¿žæŽ¥ï¼‰
          git checkout -b "$SYNC_BRANCH"
          
          echo "âœ… Created sync branch: $SYNC_BRANCH"
      
      - name: Sync rspack content
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          cd target-repo
          
          # æ¸…ç©ºå½“å‰å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
          echo "ðŸ—‘ï¸ Clearing current content..."
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # å¤åˆ¶rspackå†…å®¹
          echo "ðŸ“‹ Copying rspack content..."
          cp -r ../rspack-source/* . 2>/dev/null || echo "No regular files to copy"
          cp -r ../rspack-source/.[^.]* . 2>/dev/null || echo "No hidden files to copy"
          
          # å¤„ç†workflowæ–‡ä»¶æƒé™é—®é¢˜
          if [ -d ".github/workflows" ]; then
            echo "âš ï¸ Found rspack workflows, checking permissions..."
            
            # å¤‡ä»½åŽŸæœ‰çš„åŒæ­¥å·¥ä½œæµ
            if [ -f ".github/workflows/sync-rspack-tag.yml" ]; then
              cp .github/workflows/sync-rspack-tag.yml /tmp/sync-workflow-backup.yml
            fi
            
            # ç§»é™¤rspackçš„workflowsï¼ˆé¿å…æƒé™é—®é¢˜ï¼‰
            rm -rf .github/workflows
            
            # æ¢å¤åŒæ­¥å·¥ä½œæµ
            mkdir -p .github/workflows
            if [ -f "/tmp/sync-workflow-backup.yml" ]; then
              cp /tmp/sync-workflow-backup.yml .github/workflows/sync-rspack-tag.yml
              echo "âœ… Preserved sync workflow"
            else
              echo "âš ï¸ Sync workflow will need to be restored manually"
            fi
            
            echo "ðŸ“‹ Excluded rspack workflows to avoid permission issues"
          fi
          
          echo "âœ… Content synced successfully"
      
      - name: Commit and push changes
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          cd target-repo
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "ðŸ“‹ No changes to commit"
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            # æäº¤å˜æ›´
            git commit -m "ðŸ”„ Sync to rspack $TAG" -m "Synced from: https://github.com/web-infra-dev/rspack/tree/$TAG" -m "Note: Rspack workflows excluded to avoid permission issues"
            
            # æŽ¨é€åŒæ­¥åˆ†æ”¯
            git push origin "$SYNC_BRANCH"
            
            echo "âœ… Changes committed and pushed"
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi
      
      - name: Create Pull Request
        if: env.NO_CHANGES == 'false'
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          cd target-repo
          
          # åˆ›å»ºPR
          gh pr create \
            --title "ðŸ”„ Sync to rspack $TAG" \
            --body "Complete sync to rspack $TAG using git clone method. Includes all source code and configs. Rspack workflows excluded to avoid permission issues." \
            --head "$SYNC_BRANCH"
          
          echo "âœ… Pull Request created successfully"
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "## ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Git clone with history preservation" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: rspack $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $SYNC_BRANCH" >> $GITHUB_STEP_SUMMARY
          if [ "$NO_CHANGES" = "true" ]; then
            echo "- **Status**: âœ… No changes needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âœ… PR created" >> $GITHUB_STEP_SUMMARY 