name: Sync Rspack Tag
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Rspack tag to sync (e.g., v1.4.0)'
        required: true
        type: string

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Download and extract tag
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "ðŸ”„ Downloading rspack tag: $TAG"
          
          # ä¸‹è½½æŒ‡å®štagçš„ä»£ç 
          DOWNLOAD_URL="https://github.com/web-infra-dev/rspack/archive/refs/tags/$TAG.tar.gz"
          echo "Download URL: $DOWNLOAD_URL"
          
          if wget -O rspack-tag.tar.gz "$DOWNLOAD_URL"; then
            echo "âœ… Downloaded successfully"
          else
            echo "âŒ Failed to download tag $TAG"
            echo "è¯·æ£€æŸ¥tagæ˜¯å¦å­˜åœ¨: https://github.com/web-infra-dev/rspack/tags"
            exit 1
          fi
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨ä¸”ä¸ä¸ºç©º
          if [ ! -f rspack-tag.tar.gz ] || [ ! -s rspack-tag.tar.gz ]; then
            echo "âŒ Downloaded file is missing or empty"
            exit 1
          fi
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶è§£åŽ‹
          mkdir -p temp-rspack
          
          echo "ðŸ“¦ Extracting archive..."
          if tar -xzf rspack-tag.tar.gz -C temp-rspack --strip-components=1; then
            echo "âœ… Extracted successfully"
          else
            echo "âŒ Failed to extract archive"
            exit 1
          fi
          
          # éªŒè¯è§£åŽ‹ç»“æžœ
          if [ ! "$(ls -A temp-rspack)" ]; then
            echo "âŒ Extracted directory is empty"
            exit 1
          fi
          
          echo "ðŸ“‹ Extracted files:"
          ls -la temp-rspack/ | head -10
          
          echo "âœ… Successfully downloaded and extracted $TAG"
      
      - name: Create sync branch
        run: |
          TAG="${{ github.event.inputs.tag }}"
          SYNC_BRANCH="sync-rspack-$TAG-$(date +%Y%m%d-%H%M%S)"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV
          
          git checkout -b "$SYNC_BRANCH"
          echo "âœ… Created sync branch: $SYNC_BRANCH"
      
      - name: Backup current state
        run: |
          echo "ðŸ’¾ Backing up current state..."
          
          # å¤‡ä»½.gitç›®å½•å’Œå·¥ä½œæµæ–‡ä»¶
          cp -r .git /tmp/git-backup
          
          # ç¡®ä¿.githubç›®å½•å­˜åœ¨å†å¤‡ä»½
          if [ -d .github ]; then
            cp -r .github /tmp/github-backup
          else
            mkdir -p /tmp/github-backup
          fi
          
          echo "âœ… Backup completed"
      
      - name: Sync content
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "ðŸ”„ Syncing content to $TAG..."
          
          # éªŒè¯temp-rspackç›®å½•å­˜åœ¨ä¸”æœ‰å†…å®¹
          if [ ! -d temp-rspack ] || [ ! "$(ls -A temp-rspack)" ]; then
            echo "âŒ temp-rspack directory is missing or empty"
            exit 1
          fi
          
          # æ¸…ç©ºå½“å‰å†…å®¹ï¼ˆé™¤äº†.gitï¼‰
          echo "ðŸ—‘ï¸ Clearing current content..."
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} + 2>/dev/null || true
          
          # å¤åˆ¶æ–°å†…å®¹
          echo "ðŸ“‹ Copying new content..."
          cp -r temp-rspack/* . 2>/dev/null || echo "Warning: No regular files to copy"
          cp -r temp-rspack/.[^.]* . 2>/dev/null || echo "Warning: No hidden files to copy"
          
          # æ¢å¤å·¥ä½œæµæ–‡ä»¶ï¼ˆä¿ç•™åŒæ­¥èƒ½åŠ›ï¼‰
          echo "ðŸ”§ Restoring workflow files..."
          mkdir -p .github/workflows
          
          if [ -f /tmp/github-backup/workflows/sync-rspack-tag.yml ]; then
            cp /tmp/github-backup/workflows/sync-rspack-tag.yml .github/workflows/
            echo "âœ… Workflow file restored"
          else
            echo "âš ï¸ Original workflow file not found, creating new one"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf temp-rspack rspack-tag.tar.gz
          
          echo "âœ… Content synced to $TAG"
      
      - name: Commit changes
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "ðŸ“‹ No changes detected, repository is already at $TAG"
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            # æäº¤å˜æ›´
            COMMIT_MSG="ðŸ”„ Sync to rspack $TAG"$'\n\n'"Synced from: https://github.com/web-infra-dev/rspack/tree/$TAG"$'\n'"Sync date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"$'\n\n'"This commit updates the repository to match rspack $TAG exactly."
            
            git commit -m "$COMMIT_MSG"
            
            echo "âœ… Changes committed"
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi
      
      - name: Push sync branch
        if: env.NO_CHANGES == 'false'
        run: |
          git push origin "$SYNC_BRANCH"
          echo "âœ… Sync branch pushed"
      
      - name: Switch back to main branch
        if: env.NO_CHANGES == 'false'
        run: |
          # èŽ·å–é»˜è®¤åˆ†æ”¯å
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
          echo "Default branch: $DEFAULT_BRANCH"
          
          # åˆ‡æ¢å›žé»˜è®¤åˆ†æ”¯
          git checkout "$DEFAULT_BRANCH"
          echo "âœ… Switched back to $DEFAULT_BRANCH"
      
      - name: Create Pull Request
        if: env.NO_CHANGES == 'false'
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          # åˆ›å»ºPRæè¿°
          PR_BODY="## ðŸš€ Rspack Tag Sync

          This PR syncs the repository to **rspack \`$TAG\`**.

          ### ðŸ“‹ Details
          - **Source**: [web-infra-dev/rspack](https://github.com/web-infra-dev/rspack)
          - **Tag**: \`$TAG\`
          - **Sync Date**: ${{ github.run_id }} (Run ID)

          ### ðŸ”— Links
          - [Tag on GitHub](https://github.com/web-infra-dev/rspack/tree/$TAG)
          - [Release Notes](https://github.com/web-infra-dev/rspack/releases/tag/$TAG)

          ### âš ï¸ Review Notes
          - This is a complete sync to match the upstream tag
          - Please review changes before merging
          - The sync workflow is preserved in \`.github/workflows/\`

          ---
          *ðŸ¤– Auto-generated by GitHub Actions*"
          
          # ä½¿ç”¨GitHub CLIåˆ›å»ºPR
          gh pr create \
            --title "ðŸ”„ Sync to rspack $TAG" \
            --body "$PR_BODY" \
            --head "$SYNC_BRANCH" \
            --label "rspack-sync,$TAG,automated"
          
          echo "âœ… Pull Request created successfully"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          echo "## ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: [rspack $TAG](https://github.com/web-infra-dev/rspack/tree/$TAG)" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Branch**: \`$SYNC_BRANCH\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "$NO_CHANGES" = "true" ]; then
            echo "- **Status**: âœ… No changes needed" >> $GITHUB_STEP_SUMMARY
            echo "- **Result**: Repository already matches $TAG" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âœ… Sync completed" >> $GITHUB_STEP_SUMMARY
            echo "- **Result**: PR created for review" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Rspack Releases](https://github.com/web-infra-dev/rspack/releases)" >> $GITHUB_STEP_SUMMARY
          echo "- [Rspack Documentation](https://rspack.rs/)" >> $GITHUB_STEP_SUMMARY 