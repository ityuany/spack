name: Sync Rspack Tag
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Rspack tag to sync (e.g., v1.4.0)'
        required: true
        type: string

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Clone rspack repository
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "ðŸ”„ Cloning rspack repository..."
          
          # å…‹éš†rspackä»“åº“
          git clone https://github.com/web-infra-dev/rspack.git rspack-repo
          cd rspack-repo
          
          echo "ðŸ“‹ Available tags:"
          git tag | grep -E "^v[0-9]" | tail -10
          
          # æ£€æŸ¥tagæ˜¯å¦å­˜åœ¨
          if ! git rev-parse --verify "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "âŒ Tag $TAG not found in rspack repository"
            echo "Available tags:"
            git tag | grep -E "^v[0-9]" | tail -20
            exit 1
          fi
          
          # åˆ‡æ¢åˆ°æŒ‡å®štag
          echo "ðŸ”„ Checking out tag $TAG..."
          git checkout "$TAG"
          
          echo "âœ… Successfully cloned rspack at tag $TAG"
      
      - name: Setup target repository
        run: |
          # ç§»é™¤rspackçš„.gitç›®å½•
          rm -rf rspack-repo/.git
          
          # åˆå§‹åŒ–æ–°çš„gitä»“åº“
          cd rspack-repo
          git init
          
          # é…ç½®è®¤è¯token
          git config credential.helper store
          echo "https://x-access-token:${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials
          
          # æ·»åŠ æ‚¨çš„ä»“åº“ä½œä¸ºè¿œç¨‹ï¼ˆä½¿ç”¨è®¤è¯URLï¼‰
          git remote add origin https://x-access-token:${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # èŽ·å–ç›®æ ‡ä»“åº“ä¿¡æ¯
          git fetch origin
          
          echo "âœ… Repository setup completed"
      
      - name: Create sync branch and commit
        run: |
          TAG="${{ github.event.inputs.tag }}"
          SYNC_BRANCH="sync-rspack-$TAG-$(date +%Y%m%d-%H%M%S)"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV
          
          cd rspack-repo
          
          # åˆ›å»ºå¹¶åˆ‡æ¢åˆ°åŒæ­¥åˆ†æ”¯
          git checkout -b "$SYNC_BRANCH"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æäº¤å˜æ›´
          git commit -m "ðŸ”„ Sync to rspack $TAG" -m "Synced from: https://github.com/web-infra-dev/rspack/tree/$TAG"
          
          # æŽ¨é€åŒæ­¥åˆ†æ”¯
          git push origin "$SYNC_BRANCH"
          
          echo "âœ… Changes committed and pushed"
      
      - name: Checkout target repository for PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      
      - name: Create Pull Request
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          # åˆ›å»ºç®€å•çš„PR
          gh pr create \
            --title "ðŸ”„ Sync to rspack $TAG" \
            --body "Complete sync to rspack $TAG using git clone method. Includes all source code, configs, and workflows." \
            --head "$SYNC_BRANCH"
          
          echo "âœ… Pull Request created successfully"
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "## ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Git clone + remote switch" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: rspack $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $SYNC_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… PR created" >> $GITHUB_STEP_SUMMARY 