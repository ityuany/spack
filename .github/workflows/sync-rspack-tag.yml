name: Sync Rspack Tag
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Rspack tag to sync (e.g., v1.4.0)'
        required: true
        type: string

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Clone rspack repository
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "🔄 Cloning rspack repository..."
          
          # 克隆rspack仓库
          git clone https://github.com/web-infra-dev/rspack.git rspack-repo
          cd rspack-repo
          
          echo "📋 Available tags:"
          git tag | grep -E "^v[0-9]" | tail -10
          
          # 检查tag是否存在
          if ! git rev-parse --verify "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "❌ Tag $TAG not found in rspack repository"
            echo "Available tags:"
            git tag | grep -E "^v[0-9]" | tail -20
            exit 1
          fi
          
          # 切换到指定tag
          echo "🔄 Checking out tag $TAG..."
          git checkout "$TAG"
          
          echo "✅ Successfully cloned rspack at tag $TAG"
      
      - name: Setup target repository
        run: |
          # 移除rspack的.git目录
          rm -rf rspack-repo/.git
          
          # 初始化新的git仓库
          cd rspack-repo
          git init
          
          # 配置认证token
          git config credential.helper store
          echo "https://x-access-token:${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials
          
          # 添加您的仓库作为远程（使用认证URL）
          git remote add origin https://x-access-token:${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # 获取目标仓库信息
          git fetch origin
          
          echo "✅ Repository setup completed"
      
      - name: Create sync branch and commit
        run: |
          TAG="${{ github.event.inputs.tag }}"
          SYNC_BRANCH="sync-rspack-$TAG-$(date +%Y%m%d-%H%M%S)"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV
          
          cd rspack-repo
          
          # 创建并切换到同步分支
          git checkout -b "$SYNC_BRANCH"
          
          # 添加所有文件
          git add .
          
          # 提交变更
          git commit -m "🔄 Sync to rspack $TAG" -m "Synced from: https://github.com/web-infra-dev/rspack/tree/$TAG"
          
          # 推送同步分支
          git push origin "$SYNC_BRANCH"
          
          echo "✅ Changes committed and pushed"
      
      - name: Checkout target repository for PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      
      - name: Create Pull Request
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          # 创建简单的PR
          gh pr create \
            --title "🔄 Sync to rspack $TAG" \
            --body "Complete sync to rspack $TAG using git clone method. Includes all source code, configs, and workflows." \
            --head "$SYNC_BRANCH"
          
          echo "✅ Pull Request created successfully"
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "## 📊 Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Git clone + remote switch" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: rspack $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $SYNC_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ PR created" >> $GITHUB_STEP_SUMMARY 