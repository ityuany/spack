name: Sync Rspack Tag
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Rspack tag to sync (e.g., v1.4.0)'
        required: true
        type: string

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Clone rspack repository
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "🔄 Cloning rspack repository..."
          
          # 克隆rspack仓库
          git clone https://github.com/web-infra-dev/rspack.git rspack-source
          cd rspack-source
          
          echo "📋 Available tags:"
          git tag | grep -E "^v[0-9]" | tail -10
          
          # 检查tag是否存在
          if ! git rev-parse --verify "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "❌ Tag $TAG not found in rspack repository"
            echo "Available tags:"
            git tag | grep -E "^v[0-9]" | tail -20
            exit 1
          fi
          
          # 切换到指定tag
          echo "🔄 Checking out tag $TAG..."
          git checkout "$TAG"
          
          echo "✅ Successfully cloned rspack at tag $TAG"
      
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          path: target-repo
      
      - name: Create sync branch from target repo
        run: |
          TAG="${{ github.event.inputs.tag }}"
          SYNC_BRANCH="sync-rspack-$TAG-$(date +%Y%m%d-%H%M%S)"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV
          
          cd target-repo
          
          # 基于main分支创建同步分支（保持git历史连接）
          git checkout -b "$SYNC_BRANCH"
          
          echo "✅ Created sync branch: $SYNC_BRANCH"
      
      - name: Sync rspack content
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          cd target-repo
          
          # 清空当前内容（保留.git目录）
          echo "🗑️ Clearing current content..."
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # 复制rspack内容
          echo "📋 Copying rspack content..."
          cp -r ../rspack-source/* . 2>/dev/null || echo "No regular files to copy"
          cp -r ../rspack-source/.[^.]* . 2>/dev/null || echo "No hidden files to copy"
          
          # 处理workflow文件权限问题
          if [ -d ".github/workflows" ]; then
            echo "⚠️ Found rspack workflows, checking permissions..."
            
            # 备份原有的同步工作流
            if [ -f ".github/workflows/sync-rspack-tag.yml" ]; then
              cp .github/workflows/sync-rspack-tag.yml /tmp/sync-workflow-backup.yml
            fi
            
            # 移除rspack的workflows（避免权限问题）
            rm -rf .github/workflows
            
            # 恢复同步工作流
            mkdir -p .github/workflows
            if [ -f "/tmp/sync-workflow-backup.yml" ]; then
              cp /tmp/sync-workflow-backup.yml .github/workflows/sync-rspack-tag.yml
              echo "✅ Preserved sync workflow"
            else
              echo "⚠️ Sync workflow will need to be restored manually"
            fi
            
            echo "📋 Excluded rspack workflows to avoid permission issues"
          fi
          
          echo "✅ Content synced successfully"
      
      - name: Commit and push changes
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          cd target-repo
          
          # 添加所有文件
          git add .
          
          # 检查是否有变更
          if git diff --staged --quiet; then
            echo "📋 No changes to commit"
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            # 提交变更
            git commit -m "🔄 Sync to rspack $TAG" -m "Synced from: https://github.com/web-infra-dev/rspack/tree/$TAG" -m "Note: Rspack workflows excluded to avoid permission issues"
            
            # 推送同步分支
            git push origin "$SYNC_BRANCH"
            
            echo "✅ Changes committed and pushed"
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi
      
      - name: Create Pull Request
        if: env.NO_CHANGES == 'false'
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          cd target-repo
          
          # 创建PR
          gh pr create \
            --title "🔄 Sync to rspack $TAG" \
            --body "Complete sync to rspack $TAG using git clone method. Includes all source code and configs. Rspack workflows excluded to avoid permission issues." \
            --head "$SYNC_BRANCH"
          
          echo "✅ Pull Request created successfully"
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "## 📊 Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Git clone with history preservation" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: rspack $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $SYNC_BRANCH" >> $GITHUB_STEP_SUMMARY
          if [ "$NO_CHANGES" = "true" ]; then
            echo "- **Status**: ✅ No changes needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ✅ PR created" >> $GITHUB_STEP_SUMMARY 