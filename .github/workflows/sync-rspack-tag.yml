name: Sync Rspack Tag
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Rspack tag to sync (e.g., v1.4.0)'
        required: true
        type: string

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write  # éœ€è¦å†™å…¥.github/workflowsæ–‡ä»¶
    
    steps:
      - name: Configure Git and install dependencies
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ç¡®ä¿rsyncå¯ç”¨ï¼ˆç”¨äºŽå®‰å…¨å¤åˆ¶æ–‡ä»¶ï¼‰
          if ! command -v rsync >/dev/null 2>&1; then
            echo "ðŸ“¦ Installing rsync..."
            sudo apt-get update -q
            sudo apt-get install -y rsync
          else
            echo "âœ… rsync is already available"
          fi
      
      - name: Clone rspack repository
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "ðŸ”„ Cloning rspack repository at tag $TAG..."
          
          # ç›´æŽ¥å…‹éš†æŒ‡å®štag
          if git clone --depth 1 --branch "$TAG" https://github.com/web-infra-dev/rspack.git rspack-source; then
            echo "âœ… Successfully cloned rspack at tag $TAG"
          else
            echo "âŒ Failed to clone tag $TAG, it may not exist"
            echo "ðŸ”„ Checking available tags..."
            
            # èŽ·å–å¯ç”¨tagsåˆ—è¡¨
            git ls-remote --tags https://github.com/web-infra-dev/rspack.git | \
              grep -E 'refs/tags/v[0-9]' | \
              sed 's/.*refs\/tags\///' | \
              sort -V | \
              tail -10
            exit 1
          fi
      
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          path: target-repo
      
      - name: Create sync branch from target repo
        run: |
          TAG="${{ github.event.inputs.tag }}"
          SYNC_BRANCH="upstream/$TAG"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV

          cd target-repo
          
          # ç¡®ä¿åœ¨mainåˆ†æ”¯
          git checkout main
          git pull origin main
          
          # æ£€æŸ¥å¹¶æ¸…ç†å¯èƒ½å­˜åœ¨çš„è¿œç¨‹åŒæ­¥åˆ†æ”¯
          if git ls-remote --heads origin "$SYNC_BRANCH" | grep -q "$SYNC_BRANCH"; then
            echo "âš ï¸ Remote branch $SYNC_BRANCH already exists, deleting it..."
            git push origin --delete "$SYNC_BRANCH" || echo "Failed to delete remote branch, will force push later"
          fi
          
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æœ¬åœ°åŒæ­¥åˆ†æ”¯
          if git branch | grep -q " $SYNC_BRANCH$"; then
            echo "ðŸ”„ Deleting existing local branch $SYNC_BRANCH..."
            git branch -D "$SYNC_BRANCH" || echo "Failed to delete local branch"
          fi
          
          # åŸºäºŽmainåˆ†æ”¯åˆ›å»ºåŒæ­¥åˆ†æ”¯ï¼ˆä¿æŒgitåŽ†å²è¿žæŽ¥ï¼‰
          git checkout -b "$SYNC_BRANCH"
          
          echo "âœ… Created sync branch: $SYNC_BRANCH based on main"
      
      - name: Sync rspack content
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          cd target-repo
          
          # æ¸…ç©ºå½“å‰å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
          echo "ðŸ—‘ï¸ Clearing current content..."
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # å¤åˆ¶rspackå†…å®¹
          echo "ðŸ“‹ Copying rspack content..."
          
          # æ£€æŸ¥æºç›®å½•å†…å®¹
          echo "ðŸ“‹ Source directory contents:"
          ls -la ../rspack-source/
          
          # å¤åˆ¶rspackçš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬workflows
          if [ -d "../rspack-source" ]; then
            # å®Œå…¨å¤åˆ¶rspackçš„æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬.githubç›®å½•å’Œæ‰€æœ‰workflowsï¼‰
            if command -v rsync >/dev/null 2>&1; then
              echo "ðŸ“‹ Using rsync to copy all rspack content (including .github workflows)"
              rsync -av --exclude='.git' ../rspack-source/ ./
            else
              echo "ðŸ“‹ rsync not available, using cp"
              # å¤åˆ¶é™¤äº†.gitç›®å½•ä¹‹å¤–çš„æ‰€æœ‰å†…å®¹
              find ../rspack-source -maxdepth 1 -mindepth 1 \
                -not -name '.git' \
                -exec cp -r {} ./ \;
            fi
            
            # éªŒè¯å…³é”®ç›®å½•æ˜¯å¦è¢«æ­£ç¡®å¤åˆ¶
            if [ -d "packages" ]; then
              echo "âœ… packages/ directory copied"
            fi
            if [ -d "crates" ]; then
              echo "âœ… crates/ directory copied"  
            fi
            if [ -f "package.json" ]; then
              echo "âœ… package.json copied"
            fi
            if [ -f "Cargo.toml" ]; then
              echo "âœ… Cargo.toml copied"
            fi
            if [ -d ".github/workflows" ]; then
              echo "âœ… .github/workflows directory copied"
              echo "ðŸ“‹ Rspack workflows available:"
              ls -la .github/workflows/
            fi
            
            echo "âœ… Rspack content copied successfully (complete sync including all workflows)"
          else
            echo "âŒ Source directory not found"
            exit 1
          fi
          
          # éªŒè¯å¤åˆ¶ç»“æžœ
          echo "ðŸ“‹ Target directory contents after copy:"
          ls -la .
          
          echo "âœ… Content synced successfully"
      
      - name: Commit and push changes
        run: |
          TAG="${{ github.event.inputs.tag }}"
          
          cd target-repo
          
          # é…ç½®gitä½¿ç”¨tokenè¿›è¡Œè®¤è¯
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # è®¾ç½®è¿œç¨‹URLä»¥ä½¿ç”¨token
          git remote set-url origin https://x-access-token:${{ secrets.SYNC_TOKEN || secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æ˜¾ç¤ºå°†è¦æäº¤çš„æ–‡ä»¶
          echo "ðŸ“‹ Files to be committed:"
          git status --porcelain
          echo "ðŸ“‹ Added files count: $(git status --porcelain | wc -l)"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "ðŸ“‹ No changes to commit"
            echo "NO_CHANGES=true" >> $GITHUB_ENV
          else
            # æäº¤å˜æ›´
            git commit -m "ðŸ”„ Sync to rspack $TAG" -m "Synced from: https://github.com/web-infra-dev/rspack/tree/$TAG" -m "Note: Complete sync including all rspack workflows"
            
            # æ˜¾ç¤ºåˆ†æ”¯ä¿¡æ¯ç”¨äºŽè°ƒè¯•
            echo "ðŸ“‹ Branch status before push:"
            git log --oneline -5
            git status
            
            # å¤„ç†å¯èƒ½çš„åˆ†æ”¯å†²çªï¼Œå¼ºåˆ¶æŽ¨é€æˆ–åˆ é™¤è¿œç¨‹åˆ†æ”¯
            echo "ðŸ“‹ Checking if remote branch exists..."
            if git ls-remote --heads origin "$SYNC_BRANCH" | grep -q "$SYNC_BRANCH"; then
              echo "âš ï¸ Remote branch $SYNC_BRANCH already exists"
              echo "ðŸ”„ Force pushing to update remote branch..."
              git push --force origin "$SYNC_BRANCH"
            else
              echo "ðŸ“‹ Remote branch doesn't exist, pushing new branch..."
              git push origin "$SYNC_BRANCH"
            fi
            
            echo "âœ… Changes committed and pushed"
            echo "NO_CHANGES=false" >> $GITHUB_ENV
          fi
      
      - name: Summary
        run: |
          TAG="${{ github.event.inputs.tag }}"
          echo "## ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Git clone with history preservation" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: rspack $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $SYNC_BRANCH" >> $GITHUB_STEP_SUMMARY
          if [ "$NO_CHANGES" = "true" ]; then
            echo "- **Status**: âœ… No changes needed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âœ… Sync completed" >> $GITHUB_STEP_SUMMARY
          fi 